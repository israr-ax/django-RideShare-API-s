<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register | RideShare</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { 
      margin:0; padding:0; 
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg, #4b79ff, #924dff);
      min-height:100vh; 
      display:flex; 
      align-items:center; 
      justify-content:center;
    }
    .card { 
      width:380px; padding:28px; border-radius:14px;
      background: rgba(255,255,255,0.12); backdrop-filter: blur(8px);
      box-shadow:0 8px 30px rgba(0,0,0,0.18);
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(20px); }
      to { opacity:1; transform: translateY(0); }
    }

    h2{ color:#fff; text-align:center; margin-bottom:18px; font-weight:600; }
    .field{ margin-bottom:12px; }

    input, select {
      width:100%; padding:12px 14px; border-radius:8px; 
      border:none; outline:none; font-size:14px;
    }
    input:focus, select:focus { 
      box-shadow:0 0 8px rgba(255,255,255,0.3); 
    }

    .btn{ width:100%; padding:12px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary{ background:#fff; }

    .text{ text-align:center; color:#fff; margin-top:10px; }
    .error{ color:#ffd2d2; font-size:13px; margin-top:6px; }

    /* Driver fields smooth toggle */
    .driver-box {
      display:none;
      margin-top:10px;
      padding:12px;
      background:rgba(255,255,255,0.15);
      border-radius:10px;
      animation: fadeIn 0.3s ease;
    }
  </style>
</head>
<body>

  <div class="card">
    <h2>Create Your Account</h2>

    <div class="field">
      <input id="username" type="text" placeholder="Username">
    </div>

    <div class="field">
      <input id="email" type="email" placeholder="Email">
    </div>

    <div class="field">
      <input id="phone" type="tel" placeholder="Phone">
    </div>

    <div class="field">
      <select id="role">
        <option value="">Select role</option>
        <option value="passenger">Passenger</option>
        <option value="driver">Driver</option>
      </select>
    </div>

    <!-- DRIVER SECTION -->
    <div id="driverSection" class="driver-box">
      <h4 style="color:white;margin-bottom:10px;">Driver Details</h4>

      <div class="field">
        <input id="vehicle_number" type="text" placeholder="Vehicle Number (e.g. ABC-1234)">
      </div>

      <div class="field">
        <input id="vehicle_model" type="text" placeholder="Vehicle Model (e.g. Corolla 2018)">
      </div>

      <div class="field">
        <select id="vehicle_type">
          <option value="">Select Vehicle Type</option>
          <option value="Car">Car</option>
          <option value="Bike">Bike</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="field">
        <label style="color:#fff;font-size:13px;margin-bottom:6px;display:block;">License Image</label>
        <input id="license_image" type="file" accept="image/*">
      </div>
    </div>
    <!-- END DRIVER SECTION -->

    <div class="field">
      <input id="password" type="password" placeholder="Password (min 6 chars)">
    </div>

    <div class="field">
      <label style="color:#fff;font-size:13px;margin-bottom:6px;display:block">Profile Image (optional)</label>
      <input id="profile_image" type="file" accept="image/*">
    </div>

    <div id="error" class="error" style="display:none"></div>

    <button id="submitBtn" class="btn btn-primary" onclick="registerUser()">Register</button>

    <p class="text">Already have an account? 
      <a href="/login" style="color:yellow">Login</a>
    </p>
  </div>

<script>
document.getElementById("role").addEventListener("change", function(){
  const box = document.getElementById("driverSection");
  box.style.display = (this.value === "driver") ? "block" : "none";
});

function showError(msg){
  const el=document.getElementById("error");
  el.style.display= msg ? "block" : "none";
  el.textContent= msg;
}

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve(null);
    const r=new FileReader();
    r.onload=()=>resolve(r.result.split(",")[1]);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

async function registerUser(){
  showError("");

  const username=document.getElementById("username").value.trim();
  const email=document.getElementById("email").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const role=document.getElementById("role").value;
  const password=document.getElementById("password").value;
  
  const profileFile=document.getElementById("profile_image").files[0];

  if(!username) return showError("Username is required");
  if(!email) return showError("Email is required");
  if(!phone) return showError("Phone is required");
  if(!role) return showError("Please select your role");
  if(password.length < 6) return showError("Password must be at least 6 characters");

  // Driver fields
  let vehicle_number=null, vehicle_model=null, vehicle_type=null, license_b64=null;

  if(role === "driver"){
    vehicle_number=document.getElementById("vehicle_number").value.trim();
    vehicle_model=document.getElementById("vehicle_model").value.trim();
    vehicle_type=document.getElementById("vehicle_type").value;

    if(!vehicle_number) return showError("Vehicle number required");
    if(!vehicle_model) return showError("Vehicle model required");
    if(!vehicle_type) return showError("Select vehicle type");

    const licenseFile = document.getElementById("license_image").files[0];
    license_b64 = await fileToBase64(licenseFile);
  }

  let profile_b64 = await fileToBase64(profileFile);

  const payload = {
    username, email, phone, role, password,
    profile_image: profile_b64,
    vehicle_number, vehicle_model, vehicle_type,
    license_image: license_b64
  };

  const btn=document.getElementById("submitBtn");
  btn.disabled=true;
  btn.textContent="Registering...";

  try{
    const res = await fetch("http://127.0.0.1:8000/api/auth/register/",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    const data = await res.json().catch(()=>null);

    if(res.status===201 || res.status===200){
      alert("Registration successful! Please login.");
      window.location.href="/login";
    } else {
      showError(data.detail || JSON.stringify(data));
    }

  }catch(err){
    console.error(err);
    showError("Network error during registration.");
  }

  btn.disabled=false;
  btn.textContent="Register";
}
</script>

</body>
</html>
